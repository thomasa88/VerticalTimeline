<!DOCTYPE html>
<html>
    <head>
        <style>
            body {
                font-family: Arial, Helvetica, sans-serif;
                font-size: 12px;
            }
            #content {
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                min-height: 95vh;
            }
            .feature {
                list-style-type: none;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
            }
            .suppressed {
                opacity: 0.5;
            }
            .parent-bar {
                display: inline-block;
                width: 3px;
                height: 16px;
                vertical-align: middle;
                margin-right: 2px;
            }
            .parents-container {
                display: inline-block;
            }
            .icon {
                width: 16px;
                height: 16px;
                vertical-align: middle;
                padding: 2px;
            }
            .icon:hover {
                background-color: #d9d9d9;
            }
            .name {
                margin-left: 5px;
            }
            .name:hover {
                outline: 1px solid silver;
            }
            .name:focus {
                background-color: #f2f2f2;
            }
            ul {
                padding-left: 12px;
            }
        </style>
    </head>
    <body>
        <div id="content">
            <div>
                <div id="message">
                    Loading...
                </div>
                <div id="timeline">
                    
                </div>
            </div>
            <div>
                 by Thomas Axelsson 2020
            </div>
        </div>
    </body>
    <script>
    // Can't access the colors from Fusion, so making up our own
    const COMPONENT_COLORS = [
        '#e79f53',
        '#4a51d7',
        '#6bfcdd',
        '#54d8f7',
    ];
    var colorMap = {};
    var nextColor = 0;

    var cancelingEdit = false;

    window.fusionJavaScriptHandler = {handle: function(action, jsonData){
        console.log("Got command:", action);
        data = JSON.parse(jsonData);
        return handle(action, data);
    }};

    function handle(action, data) {
        try {
            switch (action) {
                case 'setTimeline':
                    let message = document.getElementById('message');
                    message.innerText = data['message'];

                    let timeline = document.getElementById('timeline');
                    timeline.innerHTML = '';
                    appendItems(timeline, data['features'], data['max-parents'])

                    break;
                case 'debugger':
                    debugger;
                    break;
            }
        } catch (e) {
            console.log(e);
            console.log('exception caught with action: ' + action + ', data: ' + data);
            return 'FAILED';
        }
        return 'OK';
    }

    function appendItems(parent, features, maxParents) {
        let list = document.createElement('ul');
        for (const feature of features) {
            let listItem = document.createElement('li');
            listItem.classList.add('feature');
            if (feature.suppressed) {
                listItem.classList.add('suppressed');
            }
            listItem.title = feature.type;

            listItem.setAttribute('data-id', feature['id']);
            listItem.setAttribute('data-name', feature.name);

            if (feature['component-name']) {
                listItem.setAttribute('data-component-name', feature['component-name']);
            }

            addParentBars(listItem, feature, maxParents);

            let image = document.createElement('img');
            image.src = feature['image'];
            image.classList.add('icon');
            image.addEventListener('click', onFeatureClick);
            image.addEventListener('dblclick', onFeatureDoubleClick)
            listItem.appendChild(image);

            let name = document.createElement('span');
            name.classList.add('name');
            name.innerText = feature.name;
            name.contentEditable = true;
            name.addEventListener('keydown', onFeatureEdit);
            name.addEventListener('blur', onFeatureEditBlur);
            name.addEventListener('focus', onFeatureEditFocus);
            listItem.appendChild(name);

            if (feature.type == 'GROUP') {
                appendItems(listItem, feature.children, maxParents);
            }
            list.appendChild(listItem);
        }
        parent.appendChild(list)
    }

    function addParentBars(item, feature, maxParents) {
        let parentBars = document.createElement('span');
        parentBars.classList.add('parents-container');
        parentBars.style.width = maxParents * (3 + 2) + 'px';
        item.appendChild(parentBars);

        let parents = feature['parent-components'];
        if (!parents) {
            return;
        }

        for (const parent of parents) {
            let parentBar = document.createElement('span');
            parentBar.classList.add('parent-bar')
            parentBar.title = parent;
            color = colorMap[parent];
            if (!color) {
                if (nextColor >= COMPONENT_COLORS.length) {
                    color = 'silver';
                } else {
                    color = COMPONENT_COLORS[nextColor];
                    colorMap[parent] = color;
                    nextColor++;
                }
            }
            parentBar.style.backgroundColor = color;
            parentBars.appendChild(parentBar);
        }
    }

    function onFeatureEdit(e) {
        let item = e.target.parentElement;
        ESC_KEY = 27;
        ENTER_KEY = 13;
        if (e.which == ESC_KEY) {
            cancelingEdit = true;
            e.target.blur();
            e.preventDefault();
        } else if (e.which == ENTER_KEY) {
            e.target.blur();
            e.preventDefault();
        }
    }

    function onFeatureEditBlur(e) {
        let item = e.target.parentElement;

        if (cancelingEdit) {
            cancelingEdit = false;
            item.querySelector('.name').innerText = item.getAttribute('data-name')
            return;
        }

        let hasComponentName = item.hasAttribute('data-component-name');

        storeFeatureName(item);

        if (hasComponentName) {
            item.querySelector('.name').innerText = item.getAttribute('data-name');
        }
    }

    function onFeatureEditFocus(e) {
        let item = e.target.parentElement;

        if (item.hasAttribute('data-component-name')) {
            item.querySelector('.name').innerText = item.getAttribute('data-component-name');
        }

        let range = document.createRange();
        range.selectNodeContents(e.target);
        let sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    }

    function onFeatureClick(e) {
        let item = e.target.parentElement;

        let ret = query('selectFeature', { 'id': parseInt(item.getAttribute('data-id')) } );
        processCommands(ret);
    }

    function onFeatureDoubleClick(e) {
        let item = e.target.parentElement;

        let ret = query('editFeature', { 'id': parseInt(item.getAttribute('data-id')) } );
        processCommands(ret);
    }

    function storeFeatureName(item) {
        let value = item.querySelector('.name').innerText;
        let hasComponentName = item.hasAttribute('data-component-name');

        if (hasComponentName) {
            if (value == item.getAttribute('data-component-name')) {
                return;
            }
        } else {
            if (value == item.getAttribute('data-name')) {
                // No change
                return;
            }
        }

        ret = query('setFeatureName', { 'id': parseInt(item.getAttribute('data-id')),
                                        'value': value });
        ok = ret[0]
        if (ok) {
            item.setAttribute('data-name', value);
        } else {
            item.querySelector('.name').innerText = item.getAttribute('data-name');
        }
        processCommands(ret.slice(1));
    }

    function processCommands(commands) {
        for (let command of commands) {
            handle(command['action'], command['data']);
        }
    }

    function send(action, data = {}) {
        let commands = query(action, data);
        processCommands(commands);
    }

    function query(action, data = {}) {
        let ret = adsk.fusionSendData(action, JSON.stringify(data));
        console.log("RET:", ret);
        return JSON.parse(ret);        
    }

    function waitForSdk() {
        if (window.adsk) {
            ready();
        } else {
            console.log("Waiting for SDK");
            setTimeout(waitForSdk, 500);
        }
    }

    function ready(){
        console.log("HTML ready");
        send('ready');
    }

    document.body.onload = waitForSdk;
    console.log("script end");
    </script>
</html>
